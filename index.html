<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lexora ‚Äî Apprends l'anglais</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#7c6af7">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Lexora">
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<meta name="description" content="Application d'apprentissage de l'anglais avec exercices interactifs et correction personnalis√©e">
<link href="https://fonts.googleapis.com/css2?family=Clash+Display:wght@400;600;700&family=Cabinet+Grotesk:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #09090f;
  --surface: #111118;
  --surface2: #18181f;
  --surface3: #1f1f28;
  --accent: #7c6af7;
  --accent-glow: rgba(124,106,247,0.25);
  --green: #4ade80;
  --red: #f87171;
  --amber: #fbbf24;
  --cyan: #22d3ee;
  --text: #f0f0f8;
  --text-dim: #8888a8;
  --border: #2a2a38;
  --border-bright: #3a3a50;
  --r: 14px;
  --r-sm: 9px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Cabinet Grotesk', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* Animated grid background */
body::before {
  content: '';
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background-image:
    linear-gradient(rgba(124,106,247,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(124,106,247,0.03) 1px, transparent 1px);
  background-size: 40px 40px;
}
body::after {
  content: '';
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background:
    radial-gradient(ellipse 70% 50% at 15% 10%, rgba(124,106,247,0.08) 0%, transparent 55%),
    radial-gradient(ellipse 50% 60% at 85% 90%, rgba(34,211,238,0.05) 0%, transparent 55%);
}

/* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border-bright); border-radius: 3px; }

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
nav {
  position: sticky; top: 0; z-index: 200;
  height: 62px;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 28px;
  background: rgba(9,9,15,0.8);
  backdrop-filter: blur(24px);
  border-bottom: 1px solid var(--border);
}
.logo {
  font-family: 'Clash Display', sans-serif;
  font-size: 1.3rem; font-weight: 700;
  letter-spacing: -0.5px;
  display: flex; align-items: center; gap: 8px;
}
.logo-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--accent);
  box-shadow: 0 0 10px var(--accent);
  animation: pulse 2s infinite;
}
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.6;transform:scale(0.85)} }

.nav-right { display: flex; align-items: center; gap: 14px; }
.xp-pill {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 5px 14px;
  font-family: 'Clash Display', sans-serif;
  font-size: 0.85rem; font-weight: 600;
  color: var(--amber);
  display: flex; align-items: center; gap: 6px;
}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.app-shell {
  position: relative; z-index: 1;
  display: flex; min-height: calc(100vh - 62px);
  width: 100%;
}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
aside {
  width: 220px; flex-shrink: 0;
  padding: 28px 16px;
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column; gap: 6px;
  position: sticky; top: 62px;
  height: calc(100vh - 62px);
  overflow-y: auto;
}
.nav-item {
  display: flex; align-items: center; gap: 10px;
  padding: 11px 14px;
  border-radius: var(--r-sm);
  cursor: pointer;
  font-size: 0.88rem; font-weight: 500;
  color: var(--text-dim);
  transition: all 0.18s;
  border: 1px solid transparent;
  user-select: none;
}
.nav-item:hover { color: var(--text); background: var(--surface2); }
.nav-item.active {
  color: var(--text);
  background: var(--surface3);
  border-color: var(--border-bright);
}
.nav-item .nav-icon { font-size: 1.1rem; width: 22px; text-align: center; }
.nav-label { flex: 1; }
.nav-badge {
  font-size: 0.7rem; background: var(--accent);
  color: #fff; border-radius: 10px; padding: 1px 7px;
  font-weight: 700;
}
.sidebar-sep { height: 1px; background: var(--border); margin: 8px 0; }

/* ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ */
main {
  flex: 1; padding: 20px 40px 80px;
  overflow-y: auto;
}

/* ‚îÄ‚îÄ SECTIONS ‚îÄ‚îÄ */
.section { display: none; }
.section.active { display: block; animation: fadeUp 0.3s ease; }
@keyframes fadeUp { from{opacity:0;transform:translateY(14px)} to{opacity:1;transform:translateY(0)} }

.section-header {
  margin-bottom: 28px;
}
.section-title {
  font-family: 'Clash Display', sans-serif;
  font-size: 1.8rem; font-weight: 700;
  letter-spacing: -0.5px;
  margin-bottom: 6px;
}
.section-desc { color: var(--text-dim); font-size: 0.9rem; line-height: 1.6; }

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 24px;
  margin-bottom: 18px;
  transition: border-color 0.2s;
}
.card:hover { border-color: var(--border-bright); }
.card-label {
  font-size: 0.72rem; font-weight: 700; letter-spacing: 1.2px;
  text-transform: uppercase; color: var(--accent);
  margin-bottom: 12px;
  display: flex; align-items: center; gap: 8px;
}
.card-label::after {
  content: ''; flex: 1; height: 1px; background: var(--border);
}

/* ‚îÄ‚îÄ AI LOADING ‚îÄ‚îÄ */
.ai-loading {
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; gap: 16px;
  padding: 60px 20px;
  text-align: center;
}
.ai-spinner {
  width: 48px; height: 48px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.ai-loading-text {
  color: var(--text-dim); font-size: 0.9rem;
}
.ai-loading-text strong { color: var(--accent); }

/* ‚îÄ‚îÄ TOPIC BLOCK ‚îÄ‚îÄ */
.topic-block {
  background: linear-gradient(135deg, rgba(124,106,247,0.1), rgba(34,211,238,0.05));
  border: 1px solid rgba(124,106,247,0.3);
  border-radius: var(--r-sm);
  padding: 18px 22px;
  margin-bottom: 18px;
  font-size: 1.05rem; line-height: 1.6;
}
.topic-block .topic-tag {
  font-size: 0.72rem; text-transform: uppercase; letter-spacing: 1px;
  color: var(--accent); font-weight: 700; margin-bottom: 6px;
}

/* ‚îÄ‚îÄ TEXTAREA ‚îÄ‚îÄ */
textarea {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  color: var(--text);
  font-family: 'Cabinet Grotesk', sans-serif;
  font-size: 0.95rem; line-height: 1.7;
  padding: 16px;
  resize: vertical; min-height: 180px;
  outline: none;
  transition: border-color 0.2s;
}
textarea:focus { border-color: var(--accent); }
.word-count { text-align: right; font-size: 0.78rem; color: var(--text-dim); margin-top: 6px; }

/* ‚îÄ‚îÄ FILL BLANKS ‚îÄ‚îÄ */
.fill-sentence {
  font-size: 1rem; line-height: 2.8;
  padding: 8px 0;
}
.blank-wrap { display: inline-block; position: relative; margin: 0 4px; }
.blank-input {
  background: var(--surface2);
  border: none;
  border-bottom: 2px solid var(--accent);
  color: var(--text);
  font-family: 'Cabinet Grotesk', sans-serif;
  font-size: 0.95rem;
  padding: 2px 10px;
  width: 130px;
  text-align: center;
  outline: none;
  border-radius: 4px 4px 0 0;
  transition: border-color 0.2s, background 0.2s;
}
.blank-input.correct { border-color: var(--green); background: rgba(74,222,128,0.08); }
.blank-input.wrong { border-color: var(--red); background: rgba(248,113,113,0.08); }
.blank-hint { font-size: 0.72rem; color: var(--green); position: absolute; bottom: -18px; left: 50%; transform: translateX(-50%); white-space: nowrap; }

/* ‚îÄ‚îÄ OPTIONS / QCM ‚îÄ‚îÄ */
.reading-text-block {
  background: var(--surface2);
  border-left: 3px solid var(--accent);
  border-radius: 0 var(--r-sm) var(--r-sm) 0;
  padding: 20px 24px;
  font-size: 0.92rem; line-height: 1.85;
  color: #b8b8d0;
  margin-bottom: 24px;
}
.question-block { margin-bottom: 20px; }
.question-text {
  font-weight: 500; font-size: 0.92rem;
  margin-bottom: 10px; color: var(--text);
}
.q-number {
  display: inline-flex; align-items: center; justify-content: center;
  width: 22px; height: 22px; border-radius: 50%;
  background: var(--accent); color: #fff;
  font-size: 0.72rem; font-weight: 700;
  margin-right: 8px; flex-shrink: 0;
}
.options { display: flex; flex-direction: column; gap: 8px; }
.option {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 11px 16px;
  cursor: pointer;
  font-size: 0.88rem;
  display: flex; align-items: center; gap: 10px;
  transition: all 0.15s;
}
.option:hover { border-color: var(--border-bright); transform: translateX(2px); }
.option.selected { border-color: var(--accent); background: rgba(124,106,247,0.1); }
.option.correct { border-color: var(--green); background: rgba(74,222,128,0.1); }
.option.wrong { border-color: var(--red); background: rgba(248,113,113,0.08); }
.opt-letter {
  width: 24px; height: 24px; border-radius: 50%;
  background: var(--border); color: var(--text-dim);
  display: flex; align-items: center; justify-content: center;
  font-size: 0.72rem; font-weight: 700; flex-shrink: 0;
}

/* ‚îÄ‚îÄ FLASHCARDS ‚îÄ‚îÄ */
.topics-grid {
  display: flex; flex-wrap: wrap; gap: 8px;
  margin-bottom: 24px;
}
.topic-chip {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 8px 18px;
  font-size: 0.83rem; cursor: pointer;
  transition: all 0.18s;
  display: flex; align-items: center; gap: 6px;
  font-weight: 500;
}
.topic-chip:hover { border-color: var(--border-bright); }
.topic-chip.active { background: rgba(124,106,247,0.15); border-color: var(--accent); color: var(--accent); }

.level-row { display: flex; gap: 8px; margin-bottom: 24px; }
.level-btn {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 20px; padding: 6px 16px;
  font-size: 0.82rem; cursor: pointer; color: var(--text-dim);
  transition: all 0.15s;
}
.level-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }

.fc-wrapper {
  perspective: 1400px;
  max-width: 500px; height: 260px;
  margin: 0 auto 24px;
  cursor: pointer;
}
.fc-inner {
  width: 100%; height: 100%;
  position: relative;
  transform-style: preserve-3d;
  transition: transform 0.55s cubic-bezier(0.4,0,0.2,1);
}
.fc-inner.flipped { transform: rotateY(180deg); }
.fc-face {
  position: absolute; inset: 0;
  backface-visibility: hidden;
  border-radius: var(--r);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 32px;
  text-align: center;
}
.fc-front {
  background: var(--surface);
  border: 1px solid var(--border);
}
.fc-back {
  background: linear-gradient(135deg, rgba(124,106,247,0.18), rgba(34,211,238,0.1));
  border: 1px solid rgba(124,106,247,0.35);
  transform: rotateY(180deg);
}
.fc-word {
  font-family: 'Clash Display', sans-serif;
  font-size: 2.2rem; font-weight: 700;
  letter-spacing: -0.5px;
  margin-bottom: 8px;
}
.fc-pos { font-size: 0.78rem; color: var(--text-dim); margin-bottom: 4px; }
.fc-tap { font-size: 0.78rem; color: var(--text-dim); margin-top: 16px; }
.fc-translation {
  font-family: 'Clash Display', sans-serif;
  font-size: 1.8rem; font-weight: 700;
  color: var(--cyan); margin-bottom: 10px;
}
.fc-example { font-size: 0.84rem; color: var(--text-dim); font-style: italic; line-height: 1.5; }
.fc-mnemonic {
  font-size: 0.78rem; color: var(--amber);
  margin-top: 8px; padding: 4px 10px;
  background: rgba(251,191,36,0.1); border-radius: 6px;
}

.fc-nav {
  display: flex; align-items: center; justify-content: center;
  gap: 16px; margin-bottom: 20px;
}
.fc-progress-row { margin-bottom: 20px; }
.fc-progress-bg { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
.fc-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--cyan));
  border-radius: 2px;
  transition: width 0.4s;
}
.fc-stats { display: flex; gap: 16px; justify-content: center; margin-bottom: 16px; }
.fc-stat { font-size: 0.82rem; }
.fc-stat .num { font-family: 'Clash Display', sans-serif; font-weight: 700; }
.fc-stat .num.green { color: var(--green); }
.fc-stat .num.red { color: var(--red); }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 10px 22px; border-radius: 30px; border: none;
  font-family: 'Cabinet Grotesk', sans-serif;
  font-size: 0.88rem; font-weight: 500;
  cursor: pointer; transition: all 0.18s;
  user-select: none;
}
.btn-primary {
  background: var(--accent); color: #fff;
}
.btn-primary:hover { background: #6b5be6; transform: translateY(-1px); box-shadow: 0 6px 24px rgba(124,106,247,0.35); }
.btn-primary:disabled { opacity: 0.5; cursor: default; transform: none; box-shadow: none; }
.btn-ghost {
  background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim);
}
.btn-ghost:hover { border-color: var(--border-bright); color: var(--text); }
.btn-green { background: rgba(74,222,128,0.15); border: 1px solid var(--green); color: var(--green); }
.btn-green:hover { background: rgba(74,222,128,0.25); }
.btn-red { background: rgba(248,113,113,0.12); border: 1px solid var(--red); color: var(--red); }
.btn-red:hover { background: rgba(248,113,113,0.22); }

.actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }

select {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: var(--r-sm); color: var(--text);
  font-family: 'Cabinet Grotesk', sans-serif;
  font-size: 0.88rem; padding: 9px 14px; outline: none; cursor: pointer;
  transition: border-color 0.2s;
}
select:focus { border-color: var(--accent); }

/* ‚îÄ‚îÄ RESULT BOX ‚îÄ‚îÄ */
.result-box {
  background: var(--surface);
  border: 1px solid var(--border);
  border-left: 3px solid var(--green);
  border-radius: var(--r);
  padding: 24px;
  margin-top: 20px;
  display: none;
}
.result-box.show { display: block; animation: fadeUp 0.35s ease; }
.result-score-row { display: flex; align-items: baseline; gap: 10px; margin-bottom: 6px; }
.result-score {
  font-family: 'Clash Display', sans-serif;
  font-size: 3rem; font-weight: 700;
  color: var(--amber);
}
.result-score-label { color: var(--text-dim); font-size: 0.88rem; }
.score-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin: 10px 0 18px; }
.score-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--green));
  border-radius: 3px;
  transition: width 0.9s cubic-bezier(0.4,0,0.2,1);
}
.correction-list { display: flex; flex-direction: column; gap: 10px; margin-top: 14px; }
.corr-item {
  background: var(--surface2); border-radius: var(--r-sm);
  padding: 12px 16px; font-size: 0.88rem; line-height: 1.6;
}
.corr-item .tag {
  font-size: 0.7rem; font-weight: 700; letter-spacing: 0.8px;
  text-transform: uppercase; margin-bottom: 4px;
}
.tag-ok { color: var(--green); }
.tag-err { color: var(--red); }
.corr-answer { color: var(--green); font-weight: 600; }
.corr-wrong { color: var(--red); }
.writing-ai-feedback { font-size: 0.9rem; line-height: 1.75; color: #c0c0d8; }
.writing-ai-feedback h4 { color: var(--text); margin-bottom: 4px; margin-top: 14px; font-size: 0.92rem; }

/* ‚îÄ‚îÄ HOME ‚îÄ‚îÄ */
.home-hero {
  padding: 48px 0 36px;
  text-align: center;
}
.home-hero h1 {
  font-family: 'Clash Display', sans-serif;
  font-size: clamp(2.2rem,5vw,3.8rem); font-weight: 700;
  letter-spacing: -1px; line-height: 1.1; margin-bottom: 14px;
}
.home-hero h1 em { color: var(--accent); font-style: normal; }
.home-hero p { color: var(--text-dim); font-size: 1rem; max-width: 440px; margin: 0 auto 40px; }
.home-grid {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 14px;
}
.home-module {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--r); padding: 22px;
  cursor: pointer; transition: all 0.2s;
  position: relative; overflow: hidden;
}
.home-module::before {
  content: '';
  position: absolute; inset: 0; opacity: 0;
  background: linear-gradient(135deg, rgba(124,106,247,0.08), transparent);
  transition: opacity 0.2s;
}
.home-module:hover { border-color: var(--accent); transform: translateY(-2px); }
.home-module:hover::before { opacity: 1; }
.hm-icon { font-size: 2rem; margin-bottom: 12px; }
.hm-title {
  font-family: 'Clash Display', sans-serif;
  font-size: 1rem; font-weight: 700; margin-bottom: 4px;
}
.hm-desc { font-size: 0.8rem; color: var(--text-dim); }
.hm-badge {
  position: absolute; top: 14px; right: 14px;
  font-size: 0.68rem; font-weight: 700; letter-spacing: 0.8px;
  text-transform: uppercase; color: var(--accent);
  background: rgba(124,106,247,0.12); padding: 3px 8px; border-radius: 6px;
}

/* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
.flex-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
.separator { height: 1px; background: var(--border); margin: 20px 0; }
.text-dim { color: var(--text-dim); font-size: 0.85rem; }
.tip-box {
  background: rgba(251,191,36,0.07);
  border: 1px solid rgba(251,191,36,0.2);
  border-radius: var(--r-sm);
  padding: 12px 16px;
  font-size: 0.84rem; color: #d4b060;
  margin-bottom: 18px;
  display: flex; gap: 8px; align-items: flex-start;
}

/* ‚îÄ‚îÄ AUTH OVERLAY ‚îÄ‚îÄ */
.auth-overlay {
  position: fixed; inset: 0; z-index: 1000;
  background: var(--bg);
  display: flex; align-items: center; justify-content: center;
  padding: 20px;
}
.auth-box {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 36px 32px;
  width: 100%; max-width: 400px;
}
.auth-logo {
  font-family: 'Clash Display', sans-serif;
  font-size: 1.6rem; font-weight: 700;
  text-align: center; margin-bottom: 6px;
}
.auth-tagline {
  text-align: center; color: var(--text-dim);
  font-size: 0.85rem; margin-bottom: 28px;
}
.auth-tabs {
  display: flex; gap: 0;
  background: var(--surface2);
  border-radius: var(--r-sm);
  padding: 4px; margin-bottom: 24px;
}
.auth-tab {
  flex: 1; padding: 8px;
  text-align: center; font-size: 0.88rem;
  font-weight: 500; cursor: pointer;
  border-radius: 7px; color: var(--text-dim);
  transition: all 0.18s;
}
.auth-tab.active {
  background: var(--surface3);
  color: var(--text);
  border: 1px solid var(--border);
}
.auth-field { margin-bottom: 14px; }
.auth-field label {
  display: block; font-size: 0.78rem;
  color: var(--text-dim); margin-bottom: 5px;
  font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;
}
.auth-field input {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  color: var(--text);
  font-family: 'Cabinet Grotesk', sans-serif;
  font-size: 0.95rem; padding: 10px 14px;
  outline: none; transition: border-color 0.2s;
}
.auth-field input:focus { border-color: var(--accent); }
.auth-err {
  color: var(--red); font-size: 0.82rem;
  margin-bottom: 12px; min-height: 18px;
}
.btn-full { width: 100%; justify-content: center; border-radius: var(--r-sm); padding: 12px; }

/* Quota pill in nav */
.quota-pill {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 20px; padding: 4px 12px;
  font-size: 0.78rem; color: var(--text-dim);
  display: flex; align-items: center; gap: 5px;
}
.quota-pill span { color: var(--green); font-weight: 600; }
.btn-logout {
  background: transparent; border: 1px solid var(--border);
  border-radius: 20px; padding: 5px 12px;
  color: var(--text-dim); font-size: 0.8rem;
  cursor: pointer; transition: all 0.15s;
}
.btn-logout:hover { border-color: var(--red); color: var(--red); }
.diag-banner {
  background: linear-gradient(135deg, rgba(124,106,247,0.14), rgba(34,211,238,0.07));
  border: 1px solid rgba(124,106,247,0.3);
  border-radius: var(--r);
  padding: 24px 28px;
  display: flex; align-items: center; gap: 32px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}
.diag-level-wrap { flex: 0 0 auto; }
.diag-level-label { font-size: 0.72rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin-bottom: 4px; }
.diag-level {
  font-family: 'Clash Display', sans-serif;
  font-size: 2.6rem; font-weight: 700;
  color: var(--accent);
  line-height: 1;
}
.diag-xp-wrap { flex: 1; min-width: 160px; }
.diag-xp-label { font-size: 0.72rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin-bottom: 4px; }
.diag-xp-val {
  font-family: 'Clash Display', sans-serif;
  font-size: 1.6rem; font-weight: 700; color: var(--amber);
  margin-bottom: 6px;
}
.diag-xp-bar-bg { height: 5px; background: var(--border); border-radius: 3px; overflow: hidden; }
.diag-xp-bar { height: 100%; background: linear-gradient(90deg, var(--accent), var(--cyan)); border-radius: 3px; transition: width 0.8s; }
.diag-sessions { text-align: center; }
.diag-sess-num {
  font-family: 'Clash Display', sans-serif;
  font-size: 2rem; font-weight: 700; color: var(--cyan);
}

.diag-empty { text-align: center; padding: 8px 0 20px; }

.diag-row {
  display: flex; gap: 14px; margin-bottom: 0; flex-wrap: wrap;
}
.diag-row .card { margin-bottom: 14px; }

.skill-bar-row { margin-bottom: 14px; }
.skill-bar-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85rem; }
.skill-bar-name { font-weight: 500; }
.skill-bar-score { font-family: 'Clash Display', sans-serif; font-weight: 700; }
.skill-bg { height: 7px; background: var(--border); border-radius: 4px; overflow: hidden; }
.skill-fill { height: 100%; border-radius: 4px; transition: width 1s cubic-bezier(0.4,0,0.2,1); }
.skill-sub { font-size: 0.73rem; color: var(--text-dim); margin-top: 3px; }

.diag-list { list-style: none; display: flex; flex-direction: column; gap: 8px; }
.diag-list li {
  background: var(--surface2); border-radius: var(--r-sm);
  padding: 10px 14px; font-size: 0.86rem; line-height: 1.5;
  display: flex; gap: 10px; align-items: flex-start;
}
.diag-list li::before { content: attr(data-icon); flex-shrink: 0; }

.hist-item {
  display: flex; align-items: center; gap: 12px;
  padding: 10px 0; border-bottom: 1px solid var(--border);
  font-size: 0.85rem;
}
.hist-item:last-child { border-bottom: none; }
.hist-type {
  width: 28px; height: 28px; border-radius: 8px;
  background: var(--surface2); display: flex; align-items: center; justify-content: center;
  font-size: 0.9rem; flex-shrink: 0;
}
.hist-info { flex: 1; }
.hist-title { font-weight: 500; }
.hist-meta { font-size: 0.75rem; color: var(--text-dim); }
.hist-score {
  font-family: 'Clash Display', sans-serif; font-weight: 700;
  font-size: 1rem;
}

.diag-recommendation {
  background: var(--surface);
  border: 1px solid var(--border);
  border-left: 3px solid var(--cyan);
  border-radius: var(--r);
  padding: 18px 22px;
  font-size: 0.9rem; line-height: 1.7;
  color: var(--text-dim);
  margin-top: 4px; margin-bottom: 14px;
}
.diag-recommendation strong { color: var(--text); }

@media(max-width:700px) {
  aside { display: none; }
  main { padding: 20px 16px 80px; }
  .home-grid { grid-template-columns: 1fr; }
  .tabs-mobile { display: flex; }
  .diag-banner { gap: 18px; }
  .diag-row { flex-direction: column; }
  .quota-pill { display: none; }
  .xp-pill { display: none; }
  #navUsername { display: none; }
  nav { padding: 0 16px; }
}
.tabs-mobile {
  display: none;
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 200;
  background: rgba(9,9,15,0.95);
  backdrop-filter: blur(20px);
  border-top: 1px solid var(--border);
  padding: 8px 0;
}
.tab-m {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; gap: 3px; padding: 6px 4px;
  font-size: 0.62rem; color: var(--text-dim);
  cursor: pointer; transition: color 0.15s;
}
.tab-m .ico { font-size: 1.3rem; }
.tab-m.active { color: var(--accent); }
@media(max-width:700px) {
  .tabs-mobile { display: flex; }
  nav .logo-dot { display: none; }
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê AUTH OVERLAY ‚ïê‚ïê -->
<div id="authOverlay" class="auth-overlay">
  <div class="auth-box">
    <div class="auth-logo">Lexora</div>
    <div class="auth-tagline">Apprends l'anglais √† ton rythme</div>
    <div class="auth-tabs">
      <div class="auth-tab active" data-tab="login" onclick="switchAuthTab('login')">Connexion</div>
      <div class="auth-tab" data-tab="register" onclick="switchAuthTab('register')">Inscription</div>
    </div>

    <!-- Login -->
    <div id="loginForm">
      <div class="auth-field">
        <label>Email</label>
        <input type="email" id="loginEmail" placeholder="ton@email.com" onkeydown="if(event.key==='Enter')doLogin()">
      </div>
      <div class="auth-field">
        <label>Mot de passe</label>
        <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()">
      </div>
      <div class="auth-err" id="loginErr"></div>
      <button class="btn btn-primary btn-full" onclick="doLogin()">Se connecter</button>
    </div>

    <!-- Register -->
    <div id="registerForm" style="display:none">
      <div class="auth-field">
        <label>Email</label>
        <input type="email" id="regEmail" placeholder="ton@email.com">
      </div>
      <div class="auth-field">
        <label>Nom d'utilisateur</label>
        <input type="text" id="regUsername" placeholder="ex: jean_dupont">
      </div>
      <div class="auth-field">
        <label>Mot de passe <span style="font-weight:300;text-transform:none">(8 car. min.)</span></label>
        <input type="password" id="regPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doRegister()">
      </div>
      <div class="auth-err" id="regErr"></div>
      <button class="btn btn-primary btn-full" onclick="doRegister()">Cr√©er mon compte</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê APP ‚ïê‚ïê -->
<div id="appWrapper" style="display:none;flex-direction:column">
<nav>
  <div class="logo">
    <div class="logo-dot"></div>
    Lexora
  </div>
    <div class="quota-pill">Quota : <span id="quotaDisplay">‚Äî</span></div>
    <div class="xp-pill">‚ö° <span id="totalXP">0</span> XP</div>
    <span style="color:var(--text-dim);font-size:0.82rem" id="navUsername"></span>
    <button class="btn-logout" onclick="logout()">D√©connexion</button>
  </div>
</nav>

<div class="app-shell">
  <!-- SIDEBAR -->
  <aside>
    <div class="nav-item active" onclick="go('home')" id="nav-home">
      <span class="nav-icon">üè†</span><span class="nav-label">Accueil</span>
    </div>
    <div class="separator"></div>
    <div class="nav-item" onclick="go('writing')" id="nav-writing">
      <span class="nav-icon">‚úçÔ∏è</span><span class="nav-label">Expression √©crite</span>
    </div>
    <div class="nav-item" onclick="go('fillblanks')" id="nav-fillblanks">
      <span class="nav-icon">üî°</span><span class="nav-label">Texte √† trous</span>
    </div>
    <div class="nav-item" onclick="go('reading')" id="nav-reading">
      <span class="nav-icon">üìñ</span><span class="nav-label">Lecture & QCM</span>
    </div>
    <div class="nav-item" onclick="go('flashcards')" id="nav-flashcards">
      <span class="nav-icon">üóÇÔ∏è</span><span class="nav-label">Flashcards</span>
    </div>
  </aside>

  <!-- MAIN -->
  <main>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="section active" id="section-home">

      <!-- Header -->
      <div style="padding: 8px 0 12px">
        <div class="section-title">Tableau de bord</div>
        <div class="section-desc">Ton diagnostic √©volue automatiquement au fil de tes exercices.</div>
      </div>

      <!-- Level Banner -->
      <div class="diag-banner" id="diagBanner" style="display:none">
        <div class="diag-level-wrap">
          <div class="diag-level-label">Niveau estim√©</div>
          <div class="diag-level" id="diagLevel">‚Äî</div>
        </div>
        <div class="diag-xp-wrap">
          <div class="diag-xp-label">XP total</div>
          <div class="diag-xp-val" id="diagXPVal">0</div>
          <div class="diag-xp-bar-bg"><div class="diag-xp-bar" id="diagXPBar" style="width:0%"></div></div>
        </div>
        <div class="diag-sessions">
          <div class="diag-sess-num" id="diagSessions">0</div>
          <div class="diag-xp-label">exercices</div>
        </div>
      </div>

      <!-- No data state -->
      <div id="diagEmpty" class="diag-empty">
        <div style="font-size:2.5rem;margin-bottom:12px">üéØ</div>
        <div style="font-family:'Clash Display',sans-serif;font-weight:700;font-size:1.1rem;margin-bottom:8px">Commence un exercice !</div>
        <div style="color:var(--text-dim);font-size:0.88rem;max-width:340px;margin:0 auto 24px">Ton diagnostic de niveau appara√Ætra ici apr√®s le premier exercice compl√©t√©.</div>
        <div class="home-grid" style="max-width:500px;margin:0 auto">
          <div class="home-module" onclick="go('writing')">
            
            <div class="hm-icon">‚úçÔ∏è</div>
            <div class="hm-title">Expression √©crite</div>
            <div class="hm-desc">Correction personnalis√©e</div>
          </div>
          <div class="home-module" onclick="go('fillblanks')">
            
            <div class="hm-icon">üî°</div>
            <div class="hm-title">Texte √† trous</div>
            <div class="hm-desc">Grammaire & vocabulaire</div>
          </div>
          <div class="home-module" onclick="go('reading')">
            
            <div class="hm-icon">üìñ</div>
            <div class="hm-title">Lecture & QCM</div>
            <div class="hm-desc">Compr√©hension √©crite</div>
          </div>
          <div class="home-module" onclick="go('flashcards')">
            
            <div class="hm-icon">üóÇÔ∏è</div>
            <div class="hm-title">Flashcards</div>
            <div class="hm-desc">M√©morisation vocabulaire</div>
          </div>
        </div>
      </div>

      <!-- Diagnostic data (hidden until exercises done) -->
      <div id="diagData" style="display:none">

        <!-- Skills radar -->
        <div class="diag-row">
          <!-- Skills bars -->
          <div class="card" style="flex:1;min-width:260px">
            <div class="card-label">Comp√©tences</div>
            <div id="skillsBars"></div>
          </div>

          <!-- Radar chart -->
          <div class="card" style="flex:0 0 220px;display:flex;flex-direction:column;align-items:center">
            <div class="card-label">Profil</div>
            <canvas id="radarChart" width="180" height="180"></canvas>
          </div>
        </div>

        <!-- Strengths & weaknesses -->
        <div class="diag-row">
          <div class="card" style="flex:1">
            <div class="card-label" style="color:var(--green)">Points forts</div>
            <ul class="diag-list" id="strengths"></ul>
          </div>
          <div class="card" style="flex:1">
            <div class="card-label" style="color:var(--amber)">Points √† travailler</div>
            <ul class="diag-list" id="weaknesses"></ul>
          </div>
        </div>

        <!-- History -->
        <div class="card">
          <div class="card-label">Historique des exercices</div>
          <div id="historyList"></div>
        </div>

        <!-- Recommendation -->
        <div class="diag-recommendation" id="diagReco"></div>

        <!-- Quick access -->
        <div class="home-grid" style="margin-top:20px">
          <div class="home-module" onclick="go('writing')">
            
            <div class="hm-icon">‚úçÔ∏è</div>
            <div class="hm-title">Expression √©crite</div>
          </div>
          <div class="home-module" onclick="go('fillblanks')">
            
            <div class="hm-icon">üî°</div>
            <div class="hm-title">Texte √† trous</div>
          </div>
          <div class="home-module" onclick="go('reading')">
            
            <div class="hm-icon">üìñ</div>
            <div class="hm-title">Lecture & QCM</div>
          </div>
          <div class="home-module" onclick="go('flashcards')">
            
            <div class="hm-icon">üóÇÔ∏è</div>
            <div class="hm-title">Flashcards</div>
          </div>
        </div>
      </div>

    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WRITING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="section" id="section-writing">
      <div class="section-header">
        <div class="section-title">‚úçÔ∏è Expression √©crite</div>
        <div class="section-desc">Un sujet est g√©n√©r√© pour toi. R√©dige, puis obtiens une correction d√©taill√©e.</div>
      </div>

      <div class="flex-row" style="margin-bottom:18px">
        <label class="text-dim">Th√®me :</label>
        <select id="writingTheme">
          <option value="everyday life">Vie quotidienne</option>
          <option value="technology">Technologie</option>
          <option value="environment">Environnement</option>
          <option value="work and career">Travail & carri√®re</option>
          <option value="travel">Voyages</option>
          <option value="society">Soci√©t√©</option>
          <option value="health">Sant√©</option>
        </select>
        <label class="text-dim">Niveau :</label>
        <select id="writingLevel">
          <option value="A2">A2 ‚Äì D√©butant</option>
          <option value="B1">B1 ‚Äì Interm√©diaire</option>
          <option value="B2" selected>B2 ‚Äì Avanc√©</option>
          <option value="C1">C1 ‚Äì Expert</option>
        </select>
        <button class="btn btn-ghost" onclick="generateWritingTopic()">Nouveau sujet</button>
      </div>

      <div id="writingArea" style="display:none">
        <div class="card">
          <div class="card-label">Sujet</div>
          <div class="topic-block">
            <div class="topic-tag">WRITING PROMPT</div>
            <div id="writingPrompt"></div>
          </div>
          <textarea id="writingInput" placeholder="Write your answer here in English..." oninput="updateWC()"></textarea>
          <div class="word-count"><span id="wcCount">0</span> words</div>
          <div class="actions">
            <button class="btn btn-primary" onclick="correctWriting()" id="btnCorrectWriting">Corriger</button>
            <button class="btn btn-ghost" onclick="generateWritingTopic()">Nouveau sujet</button>
          </div>
        </div>
      </div>
      <div id="writingLoader" style="display:none"><div class="ai-loading"><div class="ai-spinner"></div><div class="ai-loading-text">G√©n√©ration du sujet‚Ä¶</div></div></div>
      <div id="writingCorrLoader" style="display:none"><div class="ai-loading"><div class="ai-spinner"></div><div class="ai-loading-text">Correction en cours‚Ä¶</div></div></div>

      <div class="result-box" id="writingResult">
        <div class="result-score-row">
          <div class="result-score" id="writingScoreVal"></div>
          <div class="result-score-label">/ 100 ‚Äî Score global</div>
        </div>
        <div class="score-bar"><div class="score-bar-fill" id="writingBarFill" style="width:0%"></div></div>
        <div class="writing-ai-feedback" id="writingFeedbackContent"></div>
        <div class="actions" style="margin-top:18px">
          <button class="btn btn-ghost" onclick="generateWritingTopic()">Nouvel exercice</button>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FILL BLANKS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="section" id="section-fillblanks">
      <div class="section-header">
        <div class="section-title">üî° Texte √† trous</div>
        <div class="section-desc">Compl√®te chaque phrase avec le mot ou la forme correcte.</div>
      </div>

      <div class="flex-row" style="margin-bottom:18px">
        <label class="text-dim">Niveau :</label>
        <select id="fillLevel">
          <option value="A2">A2 ‚Äì D√©butant</option>
          <option value="B1" selected>B1 ‚Äì Interm√©diaire</option>
          <option value="B2">B2 ‚Äì Avanc√©</option>
          <option value="C1">C1 ‚Äì Expert</option>
        </select>
        <label class="text-dim">Th√®me :</label>
        <select id="fillTheme">
          <option value="mixed grammar">Grammaire g√©n√©rale</option>
          <option value="phrasal verbs">Verbes √† particule (go on, give up‚Ä¶)</option>
          <option value="idioms">Expressions idiomatiques</option>
          <option value="prepositions">Pr√©positions (in, on, at, by‚Ä¶)</option>
          <option value="tenses">Conjugaison & temps verbaux</option>
          <option value="vocabulary">Vocabulaire courant</option>
        </select>
        <button class="btn btn-ghost" onclick="generateFill()">Nouvel exercice</button>
      </div>

      <div id="fillLoader" style="display:none"><div class="ai-loading"><div class="ai-spinner"></div><div class="ai-loading-text">Pr√©paration de l'exercice‚Ä¶</div></div></div>

      <div id="fillExercise" style="display:none">
        <div class="card">
          <div class="card-label">Compl√®te les phrases</div>
          <div id="fillSentences"></div>
          <div class="actions">
            <button class="btn btn-primary" onclick="correctFill()">Corriger</button>
            <button class="btn btn-ghost" onclick="generateFill()">Nouveau</button>
          </div>
        </div>
        <div class="result-box" id="fillResult">
          <div class="result-score-row">
            <div class="result-score" id="fillScoreVal"></div>
            <div class="result-score-label">/ 100</div>
          </div>
          <div class="score-bar"><div class="score-bar-fill" id="fillBarFill" style="width:0%"></div></div>
          <div class="correction-list" id="fillCorrList"></div>
          <div class="actions" style="margin-top:14px">
            <button class="btn btn-ghost" onclick="generateFill()">Nouvel exercice</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê READING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="section" id="section-reading">
      <div class="section-header">
        <div class="section-title">üìñ Lecture & Compr√©hension</div>
        <div class="section-desc">Un texte est g√©n√©r√© selon le th√®me choisi. Lis-le, puis r√©ponds aux questions.</div>
      </div>

      <div class="flex-row" style="margin-bottom:18px">
        <label class="text-dim">Th√®me :</label>
        <select id="readingTheme">
          <option value="technology and AI">Technologie & Num√©rique</option>
          <option value="environment and climate">Environnement</option>
          <option value="travel and culture">Voyage & Culture</option>
          <option value="business and economy">Business</option>
          <option value="science and health">Science & Sant√©</option>
          <option value="history">Histoire</option>
          <option value="arts and literature">Arts & Litt√©rature</option>
        </select>
        <label class="text-dim">Niveau :</label>
        <select id="readingLevel">
          <option value="B1">B1</option>
          <option value="B2" selected>B2</option>
          <option value="C1">C1</option>
        </select>
        <button class="btn btn-ghost" onclick="generateReading()">Nouveau texte</button>
      </div>

      <div id="readingLoader" style="display:none"><div class="ai-loading"><div class="ai-spinner"></div><div class="ai-loading-text">G√©n√©ration du texte et des questions‚Ä¶</div></div></div>

      <div id="readingExercise" style="display:none">
        <div class="card">
          <div class="card-label">Texte <span id="readingThemeLabel" style="color:var(--text-dim);text-transform:none;letter-spacing:0;font-weight:400"></span></div>
          <div class="reading-text-block" id="readingTextContent"></div>
        </div>
        <div class="card">
          <div class="card-label">Questions de compr√©hension</div>
          <div id="readingQuestionsBlock"></div>
          <div class="actions">
            <button class="btn btn-primary" onclick="correctReading()">Corriger</button>
            <button class="btn btn-ghost" onclick="generateReading()">Nouveau texte</button>
          </div>
        </div>
        <div class="result-box" id="readingResult">
          <div class="result-score-row">
            <div class="result-score" id="readingScoreVal"></div>
            <div class="result-score-label">/ 100</div>
          </div>
          <div class="score-bar"><div class="score-bar-fill" id="readingBarFill" style="width:0%"></div></div>
          <div class="correction-list" id="readingCorrList"></div>
          <div class="actions" style="margin-top:14px">
            <button class="btn btn-ghost" onclick="generateReading()">Nouveau texte</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FLASHCARDS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="section" id="section-flashcards">
      <div class="section-header">
        <div class="section-title">üóÇÔ∏è Flashcards Vocabulaire</div>
        <div class="section-desc">Choisis un th√®me et un niveau pour m√©moriser du vocabulaire avec exemples et astuces.</div>
      </div>

      <div class="flex-row" style="margin-bottom:14px">
        <label class="text-dim">Th√®me :</label>
        <select id="fcTheme">
          <option value="animals">üêæ Animaux</option>
          <option value="work and business">üíº Travail</option>
          <option value="travel">‚úàÔ∏è Voyages</option>
          <option value="food and cooking">üçΩÔ∏è Cuisine</option>
          <option value="technology">üíª Technologie</option>
          <option value="emotions and feelings">üí≠ √âmotions</option>
          <option value="nature and environment">üåø Nature</option>
          <option value="health and body">üè• Sant√©</option>
          <option value="arts and culture">üé® Arts & Culture</option>
          <option value="sports">‚öΩ Sports</option>
        </select>
        <label class="text-dim">Niveau :</label>
        <select id="fcLevel">
          <option value="A2">A2</option>
          <option value="B1" selected>B1</option>
          <option value="B2">B2</option>
          <option value="C1">C1</option>
        </select>
        <button class="btn btn-ghost" onclick="generateFlashcards()">Nouvelles cartes</button>
      </div>

      <div id="fcLoader" style="display:none"><div class="ai-loading"><div class="ai-spinner"></div><div class="ai-loading-text">G√©n√©ration des cartes‚Ä¶</div></div></div>

      <div id="fcExercise" style="display:none">
        <div class="fc-progress-row">
          <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
            <span class="text-dim" id="fcProgressLabel">Carte 1 / 10</span>
            <div class="fc-stats">
              <div class="fc-stat"><span class="num green" id="fcKnownCount">0</span> ‚úì sus</div>
              <div class="fc-stat"><span class="num red" id="fcUnknownCount">0</span> ‚úó √† revoir</div>
            </div>
          </div>
          <div class="fc-progress-bg"><div class="fc-progress-fill" id="fcProgFill" style="width:0%"></div></div>
        </div>

        <div class="fc-wrapper" onclick="fcFlip()">
          <div class="fc-inner" id="fcInner">
            <div class="fc-face fc-front">
              <div class="fc-word" id="fcWord">‚Äî</div>
              <div class="fc-pos" id="fcPos"></div>
              <div class="fc-tap">Clique pour voir la traduction</div>
            </div>
            <div class="fc-face fc-back">
              <div class="fc-translation" id="fcTranslation">‚Äî</div>
              <div class="fc-example" id="fcExample"></div>
              <div class="fc-mnemonic" id="fcMnemonic" style="display:none"></div>
            </div>
          </div>
        </div>

        <div class="fc-nav">
          <button class="btn btn-ghost" style="padding:8px 20px" onclick="fcPrev()">‚Üê Pr√©c</button>
          <span class="text-dim" id="fcNavLabel">1 / 10</span>
          <button class="btn btn-ghost" style="padding:8px 20px" onclick="fcNext()">Suiv ‚Üí</button>
        </div>

        <div style="display:flex;justify-content:center;gap:14px;margin-bottom:24px">
          <button class="btn btn-green" onclick="fcMark(true)">‚úì Je sais</button>
          <button class="btn btn-red" onclick="fcMark(false)">‚úó √Ä revoir</button>
        </div>

        <div class="result-box" id="fcResult">
          <div class="result-score-row">
            <div class="result-score" id="fcScoreVal"></div>
            <div class="result-score-label">% ma√Ætris√©</div>
          </div>
          <div class="score-bar"><div class="score-bar-fill" id="fcBarFill" style="width:0%"></div></div>
          <div id="fcFeedbackText" style="color:var(--text-dim);font-size:0.88rem;margin-top:10px"></div>
          <div class="actions" style="margin-top:14px">
            <button class="btn btn-ghost" onclick="generateFlashcards()">Nouvelles cartes</button>
            <button class="btn btn-primary" onclick="fcReview()">Revoir les erreurs</button>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- MOBILE TABS -->
<div class="tabs-mobile" id="mobileTabs">
  <div class="tab-m active" onclick="go('home')" id="tabm-home"><div class="ico">üè†</div>Accueil</div>
  <div class="tab-m" onclick="go('writing')" id="tabm-writing"><div class="ico">‚úçÔ∏è</div>√âcriture</div>
  <div class="tab-m" onclick="go('fillblanks')" id="tabm-fillblanks"><div class="ico">üî°</div>√Ä trous</div>
  <div class="tab-m" onclick="go('reading')" id="tabm-reading"><div class="ico">üìñ</div>Lecture</div>
  <div class="tab-m" onclick="go('flashcards')" id="tabm-flashcards"><div class="ico">üóÇÔ∏è</div>Vocab</div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentSection = 'home';

function go(section) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.querySelectorAll('.tab-m').forEach(t => t.classList.remove('active'));
  document.getElementById('section-' + section).classList.add('active');
  document.getElementById('nav-' + section)?.classList.add('active');
  document.getElementById('tabm-' + section)?.classList.add('active');
  currentSection = section;
  if (section === 'home') renderDiagnostic();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DIAGNOSTIC ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Skills tracked: writing, grammar, reading, vocabulary, listening(via fc)
const diagState = {
  totalXP: 0,
  sessions: 0,
  history: [],  // [{type, label, score, skills, date}]
  skills: {
    writing:    { name: 'Expression √©crite', scores: [], icon: '‚úçÔ∏è', color: '#7c6af7' },
    grammar:    { name: 'Grammaire',         scores: [], icon: 'üî°', color: '#22d3ee' },
    reading:    { name: 'Compr√©hension',     scores: [], icon: 'üìñ', color: '#4ade80' },
    vocabulary: { name: 'Vocabulaire',       scores: [], icon: 'üóÇÔ∏è', color: '#fbbf24' },
  }
};

function addXP(pts) {
  diagState.totalXP += pts;
  document.getElementById('totalXP').textContent = diagState.totalXP;
}

function recordResult({ type, label, score, skillKey, extraSkills = {} }) {
  // skillKey = primary skill
  diagState.sessions++;
  diagState.totalXP += Math.round(score / 5);
  document.getElementById('totalXP').textContent = diagState.totalXP;

  if (skillKey && diagState.skills[skillKey]) {
    diagState.skills[skillKey].scores.push(score);
  }
  for (const [k, v] of Object.entries(extraSkills)) {
    if (diagState.skills[k]) diagState.skills[k].scores.push(v);
  }

  diagState.history.unshift({
    type, label, score,
    date: new Date().toLocaleTimeString('fr', { hour: '2-digit', minute: '2-digit' })
  });
  if (diagState.history.length > 12) diagState.history.pop();
}

function getSkillAvg(key) {
  const s = diagState.skills[key].scores;
  if (!s.length) return null;
  return Math.round(s.reduce((a,b)=>a+b,0)/s.length);
}

function estimateLevel() {
  const avgs = Object.keys(diagState.skills).map(k => getSkillAvg(k)).filter(v => v !== null);
  if (!avgs.length) return '‚Äî';
  const mean = avgs.reduce((a,b)=>a+b,0)/avgs.length;
  if (mean < 40) return 'A2';
  if (mean < 58) return 'B1';
  if (mean < 75) return 'B2';
  if (mean < 90) return 'C1';
  return 'C2';
}

function getStrengths() {
  const entries = Object.entries(diagState.skills)
    .map(([k,v]) => ({ name: v.name, avg: getSkillAvg(k) }))
    .filter(e => e.avg !== null)
    .sort((a,b) => b.avg - a.avg);
  const top = entries.filter(e => e.avg >= 65);
  if (!top.length) return entries.slice(0,1);
  return top.slice(0,3);
}

function getWeaknesses() {
  const entries = Object.entries(diagState.skills)
    .map(([k,v]) => ({ name: v.name, avg: getSkillAvg(k) }))
    .filter(e => e.avg !== null)
    .sort((a,b) => a.avg - b.avg);
  return entries.filter(e => e.avg < 70).slice(0, 3);
}

const strengthTips = {
  'Expression √©crite': ['Ton √©criture est fluide', 'Bonne ma√Ætrise de la structure'],
  'Grammaire': ['Bonne ma√Ætrise des temps', 'Les structures complexes te r√©ussissent'],
  'Compr√©hension': ['Tu comprends bien les textes longs', 'Bonne analyse des nuances'],
  'Vocabulaire': ['Riche palette de mots', 'Bonne m√©morisation du vocabulaire'],
};
const weaknessTips = {
  'Expression √©crite': ['Travaille les connecteurs logiques', 'Enrichis ton vocabulaire de transition'],
  'Grammaire': ['Revoir les temps conditionnels', 'Pratiquer les phrasal verbs'],
  'Compr√©hension': ['Lire des articles en anglais quotidiennement', 'Travailler les inf√©rences'],
  'Vocabulaire': ['Augmenter le nombre de flashcards', 'Pratiquer les collocations'],
};

function renderDiagnostic() {
  const hasData = diagState.sessions > 0;
  document.getElementById('diagEmpty').style.display = hasData ? 'none' : 'block';
  document.getElementById('diagData').style.display = hasData ? 'block' : 'none';
  document.getElementById('diagBanner').style.display = hasData ? 'flex' : 'none';

  const level = estimateLevel();
  document.getElementById('diagLevel').textContent = level;
  document.getElementById('diagXPVal').textContent = diagState.totalXP;
  document.getElementById('diagSessions').textContent = diagState.sessions;

  const xpForNext = (diagState.totalXP % 100);
  document.getElementById('diagXPBar').style.width = xpForNext + '%';

  if (!hasData) return;

  // Skills bars
  const sb = document.getElementById('skillsBars');
  sb.innerHTML = '';
  for (const [k, skill] of Object.entries(diagState.skills)) {
    const avg = getSkillAvg(k);
    const count = skill.scores.length;
    if (avg === null) continue;
    const color = skill.color;
    const sublabel = count === 1 ? '1 exercice' : `${count} exercices ¬∑ moy. ${avg}/100`;
    sb.innerHTML += `
      <div class="skill-bar-row">
        <div class="skill-bar-header">
          <span class="skill-bar-name">${skill.icon} ${skill.name}</span>
          <span class="skill-bar-score" style="color:${color}">${avg}/100</span>
        </div>
        <div class="skill-bg"><div class="skill-fill" style="width:${avg}%;background:${color}"></div></div>
        <div class="skill-sub">${sublabel}</div>
      </div>`;
  }

  // Radar chart
  drawRadar();

  // Strengths
  const strEl = document.getElementById('strengths');
  const strong = getStrengths();
  strEl.innerHTML = strong.length
    ? strong.map(s => {
        const tips = strengthTips[s.name] || [];
        const tip = tips[Math.floor(Math.random()*tips.length)] || '';
        return `<li data-icon="‚úì">${tip || s.name} <span style="color:var(--green);font-family:'Clash Display',sans-serif">${s.avg}/100</span></li>`;
      }).join('')
    : '<li data-icon="‚Äî">Compl√®te plus d\'exercices pour voir tes points forts.</li>';

  // Weaknesses
  const weakEl = document.getElementById('weaknesses');
  const weak = getWeaknesses();
  weakEl.innerHTML = weak.length
    ? weak.map(w => {
        const tips = weaknessTips[w.name] || [];
        const tip = tips[Math.floor(Math.random()*tips.length)] || w.name;
        return `<li data-icon="‚Üí">${tip} <span style="color:var(--amber);font-family:'Clash Display',sans-serif">${w.avg}/100</span></li>`;
      }).join('')
    : '<li data-icon="‚úì">Pas de point faible identifi√©. Continue ainsi !</li>';

  // History
  const histEl = document.getElementById('historyList');
  const icons = { writing:'‚úçÔ∏è', fill:'üî°', reading:'üìñ', fc:'üóÇÔ∏è' };
  histEl.innerHTML = diagState.history.map(h => `
    <div class="hist-item">
      <div class="hist-type">${icons[h.type]||'üìù'}</div>
      <div class="hist-info">
        <div class="hist-title">${h.label}</div>
        <div class="hist-meta">${h.date}</div>
      </div>
      <div class="hist-score" style="color:${h.score>=70?'var(--green)':h.score>=50?'var(--amber)':'var(--red)'}">${h.score}/100</div>
    </div>`).join('') || '<div style="color:var(--text-dim);font-size:0.85rem">Aucun historique.</div>';

  // Recommendation
  const reco = document.getElementById('diagReco');
  const allAvgs = Object.entries(diagState.skills).map(([k,v])=>({k,avg:getSkillAvg(k)})).filter(e=>e.avg!==null);
  if (allAvgs.length) {
    const worst = allAvgs.sort((a,b)=>a.avg-b.avg)[0];
    const skillName = diagState.skills[worst.k].name;
    const levelNow = estimateLevel();
    reco.innerHTML = `üí° <strong>Recommandation :</strong> Ton niveau estim√© est <strong>${levelNow}</strong>. 
    Concentre-toi sur <strong>${skillName}</strong> (score moyen : ${worst.avg}/100) pour progresser rapidement. 
    ${worst.avg < 50 ? 'Un travail r√©gulier sur cet axe te permettra de gagner rapidement un demi-niveau.' : 'Tu es sur la bonne voie !'}`;
  }
}

function drawRadar() {
  const canvas = document.getElementById('radarChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = 180, H = 180, cx = 90, cy = 90, r = 65;
  ctx.clearRect(0, 0, W, H);

  const keys = Object.keys(diagState.skills);
  const n = keys.length;
  const angles = keys.map((_,i) => (Math.PI * 2 * i / n) - Math.PI/2);

  // Grid
  for (let g = 1; g <= 4; g++) {
    ctx.beginPath();
    angles.forEach((a, i) => {
      const x = cx + Math.cos(a) * (r * g/4);
      const y = cy + Math.sin(a) * (r * g/4);
      i === 0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    });
    ctx.closePath();
    ctx.strokeStyle = 'rgba(255,255,255,0.06)';
    ctx.lineWidth = 1;
    ctx.stroke();
  }

  // Axes
  angles.forEach(a => {
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(cx + Math.cos(a)*r, cy + Math.sin(a)*r);
    ctx.strokeStyle = 'rgba(255,255,255,0.08)';
    ctx.stroke();
  });

  // Data
  const vals = keys.map(k => (getSkillAvg(k) || 0) / 100);
  ctx.beginPath();
  angles.forEach((a, i) => {
    const x = cx + Math.cos(a) * r * vals[i];
    const y = cy + Math.sin(a) * r * vals[i];
    i === 0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
  });
  ctx.closePath();
  ctx.fillStyle = 'rgba(124,106,247,0.2)';
  ctx.fill();
  ctx.strokeStyle = '#7c6af7';
  ctx.lineWidth = 2;
  ctx.stroke();

  // Dots
  angles.forEach((a, i) => {
    const x = cx + Math.cos(a) * r * vals[i];
    const y = cy + Math.sin(a) * r * vals[i];
    ctx.beginPath();
    ctx.arc(x, y, 4, 0, Math.PI*2);
    ctx.fillStyle = '#7c6af7';
    ctx.fill();
  });

  // Labels
  ctx.font = '10px Cabinet Grotesk, sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.45)';
  ctx.textAlign = 'center';
  const icons2 = ['‚úçÔ∏è','üî°','üìñ','üóÇÔ∏è'];
  angles.forEach((a, i) => {
    const x = cx + Math.cos(a) * (r + 16);
    const y = cy + Math.sin(a) * (r + 16) + 4;
    ctx.fillText(icons2[i], x, y);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIG & AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const API_BASE = 'https://lexora-zopy.onrender.com/api';
// ‚òùÔ∏è Remplace par l'URL exacte que Render te donnera apr√®s d√©ploiement

// ‚îÄ‚îÄ Service Worker (PWA) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .then(reg => console.log('SW enregistr√©:', reg.scope))
      .catch(err => console.log('SW erreur:', err));
  });
}

let authToken = localStorage.getItem('eu_token') || null;
let currentUser = null;

// Affiche le bon √©cran au chargement
window.addEventListener('DOMContentLoaded', () => {
  if (authToken) {
    fetchMe().then(() => showApp()).catch(() => showAuth());
  } else {
    showAuth();
  }
});

function showAuth() {
  document.getElementById('authOverlay').style.display = 'flex';
  document.getElementById('appWrapper').style.display = 'none';
}
function showApp() {
  document.getElementById('authOverlay').style.display = 'none';
  document.getElementById('appWrapper').style.display = 'flex';
  updateQuotaDisplay();
}
function logout() {
  authToken = null;
  currentUser = null;
  localStorage.removeItem('eu_token');
  showAuth();
}

// ‚îÄ‚îÄ Auth forms ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const pass  = document.getElementById('loginPass').value;
  const errEl = document.getElementById('loginErr');
  errEl.textContent = '';
  try {
    const res = await fetch(`${API_BASE}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password: pass })
    });
    const data = await res.json();
    if (!res.ok) { errEl.textContent = data.detail || 'Identifiants incorrects'; return; }
    authToken = data.access_token;
    localStorage.setItem('eu_token', authToken);
    await fetchMe();
    showApp();
  } catch(e) {
    errEl.textContent = 'Erreur r√©seau. R√©essaie.';
  }
}

async function doRegister() {
  const email    = document.getElementById('regEmail').value.trim();
  const username = document.getElementById('regUsername').value.trim();
  const pass     = document.getElementById('regPass').value;
  const errEl    = document.getElementById('regErr');
  errEl.textContent = '';
  try {
    const res = await fetch(`${API_BASE}/auth/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, username, password: pass })
    });
    const data = await res.json();
    if (!res.ok) { errEl.textContent = data.detail || 'Erreur inscription'; return; }
    // Auto-login
    document.getElementById('loginEmail').value = email;
    document.getElementById('loginPass').value = pass;
    switchAuthTab('login');
    await doLogin();
  } catch(e) {
    errEl.textContent = 'Erreur r√©seau. R√©essaie.';
  }
}

async function fetchMe() {
  const res = await apiFetch('/auth/me');
  currentUser = await res.json();
  document.getElementById('navUsername').textContent = currentUser.username;
}

async function updateQuotaDisplay() {
  try {
    const res = await apiFetch('/auth/quota');
    const q = await res.json();
    document.getElementById('quotaDisplay').textContent =
      `${q.remaining}/${q.daily_quota} restants`;
  } catch(e) {}
}

function switchAuthTab(tab) {
  document.getElementById('loginForm').style.display  = tab === 'login'    ? 'block' : 'none';
  document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
  document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.auth-tab[data-tab="${tab}"]`).classList.add('active');
}

// ‚îÄ‚îÄ Generic authenticated fetch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function apiFetch(path, options = {}) {
  const res = await fetch(`${API_BASE}${path}`, {
    ...options,
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${authToken}`,
      ...(options.headers || {}),
    },
  });
  if (res.status === 401) { logout(); throw new Error('Session expir√©e'); }
  if (res.status === 429) {
    const d = await res.json();
    throw new Error(d.detail || 'Quota journalier atteint');
  }
  return res;
}

async function apiPost(path, body) {
  const res = await apiFetch(path, { method: 'POST', body: JSON.stringify(body) });
  if (!res.ok) {
    const d = await res.json().catch(() => ({}));
    throw new Error(d.detail || `Erreur ${res.status}`);
  }
  const data = await res.json();
  updateQuotaDisplay();
  return data;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WRITING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let writingPromptData = null;

async function generateWritingTopic() {
  const theme = document.getElementById('writingTheme').value;
  const level = document.getElementById('writingLevel').value;
  document.getElementById('writingArea').style.display = 'none';
  document.getElementById('writingResult').classList.remove('show');
  document.getElementById('writingLoader').style.display = 'block';
  try {
    writingPromptData = await apiPost('/generate/writing-topic', { theme, level });
    document.getElementById('writingPrompt').innerHTML =
      `<div style="margin-bottom:12px">${writingPromptData.prompt}</div>` +
      `<div style="font-size:0.8rem;color:var(--text-dim)">üí° Tips: ${writingPromptData.hints.join(' ‚Ä¢ ')}</div>`;
    document.getElementById('writingInput').value = '';
    document.getElementById('wcCount').textContent = '0';
    document.getElementById('writingLoader').style.display = 'none';
    document.getElementById('writingArea').style.display = 'block';
  } catch(e) {
    document.getElementById('writingLoader').style.display = 'none';
    alert(e.message || 'Erreur lors de la g√©n√©ration. R√©essaie.');
  }
}

function updateWC() {
  const words = document.getElementById('writingInput').value.trim().split(/\s+/).filter(w=>w.length>0).length;
  document.getElementById('wcCount').textContent = words;
}

async function correctWriting() {
  const text = document.getElementById('writingInput').value.trim();
  const words = text.split(/\s+/).filter(w=>w.length>0).length;
  const minW = writingPromptData?.min_words || 60;
  if (words < minW) { alert(`√âcris au moins ${minW} mots ! (${words} actuellement)`); return; }
  document.getElementById('writingArea').style.display = 'none';
  document.getElementById('writingCorrLoader').style.display = 'block';
  document.getElementById('writingResult').classList.remove('show');
  const level = document.getElementById('writingLevel').value;
  try {
    const data = await apiPost('/generate/correct-writing', {
      prompt: writingPromptData.prompt, text, level
    });
    document.getElementById('writingCorrLoader').style.display = 'none';
    document.getElementById('writingArea').style.display = 'block';
    const score = data.score;
    document.getElementById('writingScoreVal').textContent = score;
    document.getElementById('writingBarFill').style.width = score + '%';
    let html = `<h4>üåü Points forts</h4><ul style="padding-left:18px;color:var(--green)">` +
      data.strengths.map(s=>`<li>${s}</li>`).join('') + `</ul>`;
    html += `<h4>üìà Points √† am√©liorer</h4><ul style="padding-left:18px;color:var(--amber)">` +
      data.improvements.map(i=>`<li>${i}</li>`).join('') + `</ul>`;
    if (data.corrected_sentences?.length) {
      html += `<h4>‚úèÔ∏è Corrections d√©taill√©es</h4>`;
      data.corrected_sentences.forEach(c => {
        html += `<div class="corr-item">
          <div class="tag tag-err">Original</div><div class="corr-wrong">${c.original}</div>
          <div class="tag tag-ok" style="margin-top:6px">Correction</div><div class="corr-answer">${c.corrected}</div>
          <div style="color:var(--text-dim);font-size:0.82rem;margin-top:4px">${c.explanation}</div>
        </div>`;
      });
    }
    html += `<div style="margin-top:16px;padding:14px 18px;background:rgba(124,106,247,0.08);border-radius:var(--r-sm);border:1px solid rgba(124,106,247,0.2)">üí¨ ${data.overall_comment}</div>`;
    html += `<div style="display:flex;gap:14px;margin-top:12px;font-size:0.82rem;color:var(--text-dim)">
      <span>üìù Grammaire: <strong style="color:var(--text)">${data.grammar_score}/100</strong></span>
      <span>üìö Vocabulaire: <strong style="color:var(--text)">${data.vocabulary_score}/100</strong></span>
      <span>üîó Coh√©rence: <strong style="color:var(--text)">${data.coherence_score}/100</strong></span>
    </div>`;
    document.getElementById('writingFeedbackContent').innerHTML = html;
    document.getElementById('writingResult').classList.add('show');
    recordResult({ type:'writing', label:'Expression √©crite ‚Äî '+document.getElementById('writingTheme').value,
      score, skillKey:'writing', extraSkills:{grammar:data.grammar_score, vocabulary:data.vocabulary_score} });
  } catch(e) {
    document.getElementById('writingCorrLoader').style.display = 'none';
    document.getElementById('writingArea').style.display = 'block';
    alert(e.message || 'Erreur correction. R√©essaie.');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILL IN THE BLANKS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let fillData = [];

async function generateFill() {
  const level = document.getElementById('fillLevel').value;
  const theme = document.getElementById('fillTheme').value;
  document.getElementById('fillExercise').style.display = 'none';
  document.getElementById('fillResult').classList.remove('show');
  document.getElementById('fillLoader').style.display = 'block';
  try {
    fillData = await apiPost('/generate/fill-blanks', { level, theme });
    document.getElementById('fillLoader').style.display = 'none';
    renderFill();
    document.getElementById('fillExercise').style.display = 'block';
  } catch(e) {
    document.getElementById('fillLoader').style.display = 'none';
    alert(e.message || 'Erreur g√©n√©ration. R√©essaie.');
  }
}

function renderFill() {
  const container = document.getElementById('fillSentences');
  container.innerHTML = '';
  fillData.forEach((item, i) => {
    const parts = item.sentence.split('___');
    const div = document.createElement('div');
    div.className = 'fill-sentence';
    div.innerHTML = `<span style="color:var(--text-dim);font-size:0.8rem;margin-right:6px">${i+1}.</span>` +
      parts[0] +
      `<span class="blank-wrap"><input class="blank-input" id="blank_${i}" type="text" placeholder="..." autocomplete="off"></span>` +
      (parts[1] || '');
    container.appendChild(div);
  });
}

function correctFill() {
  let correct = 0;
  const corrList = document.getElementById('fillCorrList');
  corrList.innerHTML = '';
  fillData.forEach((item, i) => {
    const input = document.getElementById('blank_' + i);
    const userAns = input.value.trim().toLowerCase();
    const correctAns = item.answer.toLowerCase();
    const isOk = userAns === correctAns || correctAns.includes(userAns);
    if (isOk) { correct++; input.classList.add('correct'); } else { input.classList.add('wrong'); }
    const div = document.createElement('div');
    div.className = 'corr-item';
    div.innerHTML = `<div class="tag ${isOk?'tag-ok':'tag-err'}">${isOk?'‚úì Correct':'‚úó Incorrect'}</div>
      <div>${item.sentence.replace('___', `<strong style="color:${isOk?'var(--green)':'var(--red)'}">${userAns||'(vide)'}</strong>`)}</div>
      ${!isOk ? `<div style="margin-top:4px">R√©ponse : <span class="corr-answer">${item.answer}</span></div>` : ''}
      <div style="color:var(--text-dim);font-size:0.8rem;margin-top:4px">${item.explanation}</div>`;
    corrList.appendChild(div);
  });
  const pct = Math.round(correct / fillData.length * 100);
  document.getElementById('fillScoreVal').textContent = pct;
  document.getElementById('fillBarFill').style.width = pct + '%';
  document.getElementById('fillResult').classList.add('show');
  const fillSel = document.getElementById('fillTheme');
  const fillLabel = fillSel.options[fillSel.selectedIndex].text.split('(')[0].trim();
  recordResult({ type:'fill', label:'Texte √† trous ‚Äî '+fillLabel, score:pct, skillKey:'grammar' });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  READING & QCM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let readingData = null;
let readingAnswers = [];

async function generateReading() {
  const theme = document.getElementById('readingTheme').value;
  const level = document.getElementById('readingLevel').value;
  document.getElementById('readingExercise').style.display = 'none';
  document.getElementById('readingResult').classList.remove('show');
  document.getElementById('readingLoader').style.display = 'block';
  readingAnswers = [];
  try {
    readingData = await apiPost('/generate/reading', { theme, level });
    document.getElementById('readingLoader').style.display = 'none';
    document.getElementById('readingThemeLabel').textContent = '‚Äî ' + readingData.title;
    document.getElementById('readingTextContent').innerHTML =
      readingData.text.split('\n').filter(p=>p.trim()).map(p=>`<p style="margin-bottom:12px">${p}</p>`).join('');
    const qBlock = document.getElementById('readingQuestionsBlock');
    qBlock.innerHTML = '';
    readingAnswers = new Array(readingData.questions.length).fill(null);
    readingData.questions.forEach((q, qi) => {
      const div = document.createElement('div');
      div.className = 'question-block';
      div.innerHTML = `<div class="question-text"><span class="q-number">${qi+1}</span>${q.q}</div>
        <div class="options" id="opts_${qi}">
          ${q.options.map((opt, oi) =>
            `<div class="option" onclick="selectOption(${qi},${oi})" id="opt_${qi}_${oi}">
              <div class="opt-letter">${String.fromCharCode(65+oi)}</div>${opt}
            </div>`
          ).join('')}
        </div>`;
      qBlock.appendChild(div);
    });
    document.getElementById('readingExercise').style.display = 'block';
  } catch(e) {
    document.getElementById('readingLoader').style.display = 'none';
    alert(e.message || 'Erreur g√©n√©ration. R√©essaie.');
  }
}

function selectOption(qi, oi) {
  readingAnswers[qi] = oi;
  const opts = document.getElementById('opts_' + qi);
  opts.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
  document.getElementById(`opt_${qi}_${oi}`).classList.add('selected');
}

function correctReading() {
  if (readingAnswers.includes(null)) { alert('R√©ponds √† toutes les questions !'); return; }
  let correct = 0;
  const corrList = document.getElementById('readingCorrList');
  corrList.innerHTML = '';
  readingData.questions.forEach((q, qi) => {
    const userAns = readingAnswers[qi];
    const correctAns = q.answer;
    const isOk = userAns === correctAns;
    if (isOk) correct++;
    const opts = document.getElementById('opts_' + qi);
    opts.querySelectorAll('.option').forEach((o, oi) => {
      o.classList.remove('selected');
      if (oi === correctAns) o.classList.add('correct');
      else if (oi === userAns && !isOk) o.classList.add('wrong');
    });
    const div = document.createElement('div');
    div.className = 'corr-item';
    div.innerHTML = `<div class="tag ${isOk?'tag-ok':'tag-err'}">${isOk?'‚úì Correct':'‚úó Incorrect'}</div>
      <div style="margin-bottom:4px">${q.q}</div>
      <div>Ta r√©ponse : <span class="${isOk?'corr-answer':'corr-wrong'}">${q.options[userAns]}</span></div>
      ${!isOk ? `<div>Bonne r√©ponse : <span class="corr-answer">${q.options[correctAns]}</span></div>` : ''}`;
    corrList.appendChild(div);
  });
  const pct = Math.round(correct / readingData.questions.length * 100);
  document.getElementById('readingScoreVal').textContent = pct;
  document.getElementById('readingBarFill').style.width = pct + '%';
  document.getElementById('readingResult').classList.add('show');
  recordResult({ type:'reading', label:'Lecture ‚Äî '+(readingData.title||''), score:pct, skillKey:'reading' });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FLASHCARDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let fcCards = [];
let fcIndex = 0;
let fcKnown = new Set();
let fcUnknown = new Set();
let fcFlipped = false;

async function generateFlashcards() {
  const theme = document.getElementById('fcTheme').value;
  const level = document.getElementById('fcLevel').value;
  document.getElementById('fcExercise').style.display = 'none';
  document.getElementById('fcResult').classList.remove('show');
  document.getElementById('fcLoader').style.display = 'block';
  fcIndex = 0; fcKnown = new Set(); fcUnknown = new Set();
  try {
    fcCards = await apiPost('/generate/flashcards', { theme, level });
    document.getElementById('fcLoader').style.display = 'none';
    document.getElementById('fcExercise').style.display = 'block';
    document.getElementById('fcResult').classList.remove('show');
    renderFC();
  } catch(e) {
    document.getElementById('fcLoader').style.display = 'none';
    alert(e.message || 'Erreur g√©n√©ration. R√©essaie.');
  }
}

function renderFC() {
  if (!fcCards.length) return;
  const card = fcCards[fcIndex];
  document.getElementById('fcInner').classList.remove('flipped');
  fcFlipped = false;
  document.getElementById('fcWord').textContent = card.word;
  document.getElementById('fcPos').textContent = card.pos;
  document.getElementById('fcTranslation').textContent = card.translation;
  document.getElementById('fcExample').textContent = '¬´ ' + card.example + ' ¬ª';
  const mn = document.getElementById('fcMnemonic');
  if (card.mnemonic) {
    mn.textContent = 'üí° ' + card.mnemonic;
    mn.style.display = 'block';
  } else { mn.style.display = 'none'; }

  const pct = ((fcIndex) / fcCards.length * 100).toFixed(0);
  document.getElementById('fcProgFill').style.width = pct + '%';
  document.getElementById('fcProgressLabel').textContent = `Carte ${fcIndex+1} / ${fcCards.length}`;
  document.getElementById('fcNavLabel').textContent = `${fcIndex+1} / ${fcCards.length}`;
  document.getElementById('fcKnownCount').textContent = fcKnown.size;
  document.getElementById('fcUnknownCount').textContent = fcUnknown.size;
}

function fcFlip() {
  fcFlipped = !fcFlipped;
  document.getElementById('fcInner').classList.toggle('flipped', fcFlipped);
}

function fcNext() {
  if (fcIndex < fcCards.length - 1) { fcIndex++; renderFC(); }
  else showFCResult();
}
function fcPrev() { if (fcIndex > 0) { fcIndex--; renderFC(); } }

function fcMark(known) {
  if (known) { fcKnown.add(fcIndex); fcUnknown.delete(fcIndex); }
  else { fcUnknown.add(fcIndex); fcKnown.delete(fcIndex); }
  document.getElementById('fcKnownCount').textContent = fcKnown.size;
  document.getElementById('fcUnknownCount').textContent = fcUnknown.size;
  if (fcIndex < fcCards.length - 1) { fcIndex++; renderFC(); }
  else showFCResult();
}

function showFCResult() {
  const pct = Math.round(fcKnown.size / fcCards.length * 100);
  document.getElementById('fcScoreVal').textContent = pct;
  document.getElementById('fcBarFill').style.width = pct + '%';
  const msgs = ['Continue √† t\'entra√Æner !', 'Bon d√©but !', 'Bien jou√© !', 'Tr√®s bon score !', 'Parfait !'];
  const idx = Math.min(Math.floor(pct/25), 4);
  document.getElementById('fcFeedbackText').textContent =
    `${fcKnown.size} / ${fcCards.length} mots ma√Ætris√©s. ${msgs[idx]}`;
  document.getElementById('fcResult').classList.add('show');
  recordResult({
    type: 'fc',
    label: 'Flashcards ‚Äî ' + document.getElementById('fcTheme').value,
    score: pct,
    skillKey: 'vocabulary'
  });
}

function fcReview() {
  const unknownCards = [...fcUnknown].map(i => fcCards[i]);
  if (!unknownCards.length) { alert('Aucun mot √† revoir ! üéâ'); return; }
  fcCards = unknownCards;
  fcIndex = 0; fcKnown = new Set(); fcUnknown = new Set();
  document.getElementById('fcResult').classList.remove('show');
  renderFC();
}

// init ‚Äî pas d'auto-g√©n√©ration pour √©viter les appels inutiles
</script>

</div><!-- /appWrapper -->
</body>
</html>
